name: Production Deploy

on:
  push:
    branches: [main]

permissions:
  contents: read
  issues: write

concurrency:
  group: production-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-deploy:
    name: Build, Deploy, Smoke Test, Rollback
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10.28.2

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Deploy to Vercel Production
        id: deploy
        shell: bash
        run: |
          set -euo pipefail
          DEPLOY_OUTPUT="$(pnpm dlx vercel@latest deploy --prod --yes --scope="$VERCEL_ORG_ID" --token="$VERCEL_TOKEN" 2>&1)"
          echo "$DEPLOY_OUTPUT"
          DEPLOYMENT_URL="$(echo "$DEPLOY_OUTPUT" | grep -Eo 'https://[a-zA-Z0-9.-]+\.vercel\.app' | tail -n1)"
          if [ -z "$DEPLOYMENT_URL" ]; then
            echo "Could not parse deployment URL from Vercel output."
            exit 1
          fi
          echo "deployment_url=$DEPLOYMENT_URL" >> "$GITHUB_OUTPUT"
          echo "Deployed to: $DEPLOYMENT_URL"

      - name: Get Previous Deployment
        id: previous
        shell: bash
        run: |
          set -euo pipefail
          API_URL="https://api.vercel.com/v6/deployments?limit=2&state=READY&target=production"
          if [ -n "${VERCEL_PROJECT_ID:-}" ]; then
            API_URL="$API_URL&projectId=$VERCEL_PROJECT_ID"
          fi
          if [ -n "${VERCEL_ORG_ID:-}" ]; then
            API_URL="$API_URL&teamId=$VERCEL_ORG_ID"
          fi

          DEPLOYMENTS_JSON="$(curl -fsSL -H "Authorization: Bearer $VERCEL_TOKEN" "$API_URL")"
          PREVIOUS_ID="$(
            printf '%s' "$DEPLOYMENTS_JSON" | node -e "
              let raw = '';
              process.stdin.on('data', (chunk) => (raw += chunk));
              process.stdin.on('end', () => {
                const data = JSON.parse(raw);
                process.stdout.write(data.deployments?.[1]?.uid ?? '');
              });
            "
          )"

          echo "previous_id=$PREVIOUS_ID" >> "$GITHUB_OUTPUT"
          echo "Previous deployment ID: ${PREVIOUS_ID:-none}"

      - name: Run Smoke Tests
        id: smoke
        continue-on-error: true
        run: pnpm tsx scripts/smoke-test-production.ts
        env:
          PRODUCTION_URL: ${{ steps.deploy.outputs.deployment_url || vars.NEXT_PUBLIC_APP_URL || '' }}

      - name: Rollback on Smoke Test Failure
        if: steps.smoke.outcome == 'failure' && steps.previous.outputs.previous_id != ''
        shell: bash
        run: |
          set -euo pipefail
          echo "üö® Smoke tests failed! Rolling back..."
          pnpm dlx vercel@latest rollback "${{ steps.previous.outputs.previous_id }}" \
            --yes \
            --scope="$VERCEL_ORG_ID" \
            --token="$VERCEL_TOKEN"
          echo "‚úÖ Rollback initiated to previous deployment: ${{ steps.previous.outputs.previous_id }}"

      - name: Rollback skipped (no previous deployment found)
        if: steps.smoke.outcome == 'failure' && steps.previous.outputs.previous_id == ''
        run: echo "‚ö†Ô∏è Smoke tests failed but no previous deployment was found for rollback."

      - name: Create Issue on Failure
        if: steps.smoke.outcome == 'failure'
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_URL: ${{ steps.deploy.outputs.deployment_url }}
        with:
          script: |
            const title = `üî¥ Production deploy failed ‚Äî ${new Date().toISOString().split('T')[0]}`;
            const body =
              `## Deploy Failure Report\n\n` +
              `**Commit:** ${context.sha}\n` +
              `**Branch:** main\n` +
              `**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n` +
              `**Deployment URL:** ${process.env.DEPLOYMENT_URL}\n` +
              `**Smoke tests:** FAILED\n` +
              `**Rollback:** Executed automatically when previous deployment was available\n\n` +
              `Please investigate immediately.\n`;

            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['bug', 'production', 'urgent'],
              });
            } catch {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
              });
            }

      - name: Notify deployment status
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.smoke.outcome }}" = "failure" ]; then
            STATUS="‚ùå FAILED (rollback executed)"
          else
            STATUS="‚úÖ SUCCESS"
          fi

          MESSAGE="METAMEN100 Production Deploy: ${STATUS}\nCommit: ${GITHUB_SHA}\nURL: ${{ steps.deploy.outputs.deployment_url }}\nRun: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          echo "Deploy status: ${STATUS}"

          if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
            curl -fsS -X POST "$SLACK_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"text\":\"${MESSAGE}\"}" || true
          fi

          if [ -n "${DISCORD_WEBHOOK_URL:-}" ]; then
            curl -fsS -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{\"content\":\"${MESSAGE}\"}" || true
          fi

      - name: Fail if smoke tests failed
        if: steps.smoke.outcome == 'failure'
        run: |
          echo "Smoke tests failed. Workflow marked as failed."
          exit 1
