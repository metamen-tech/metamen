name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  deploy-preview:
    name: Deploy Preview
    if: github.actor != 'dependabot[bot]' && github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4
        with:
          version: 10.28.2

      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify Vercel CLI
        run: pnpm dlx vercel@latest --version

      - name: Pull Vercel Environment
        run: pnpm dlx vercel@latest pull --yes --environment=preview --token="$VERCEL_TOKEN"

      - name: Build Project
        run: pnpm dlx vercel@latest build --token="$VERCEL_TOKEN"

      - name: Deploy Preview
        id: deploy
        shell: bash
        run: |
          set -euo pipefail
          DEPLOY_OUTPUT="$(pnpm dlx vercel@latest deploy --prebuilt --token="$VERCEL_TOKEN" 2>&1)"
          echo "$DEPLOY_OUTPUT"
          PREVIEW_URL="$(echo "$DEPLOY_OUTPUT" | grep -Eo 'https://[a-zA-Z0-9.-]+\.vercel\.app' | tail -n1)"
          if [ -z "$PREVIEW_URL" ]; then
            echo "Could not detect preview URL from Vercel output."
            exit 1
          fi
          echo "preview_url=$PREVIEW_URL" >> "$GITHUB_OUTPUT"

      - name: Calculate Bundle Size
        id: bundle
        shell: bash
        run: |
          set -euo pipefail
          if [ -d ".next/static/chunks" ]; then
            BUNDLE_SIZE="$(du -sh .next/static/chunks | cut -f1)"
          elif [ -d ".vercel/output/static" ]; then
            BUNDLE_SIZE="$(du -sh .vercel/output/static | cut -f1)"
          else
            BUNDLE_SIZE="N/A"
          fi
          echo "bundle_size=$BUNDLE_SIZE" >> "$GITHUB_OUTPUT"

      - name: Comment Preview URL
        uses: actions/github-script@v7
        env:
          PREVIEW_URL: ${{ steps.deploy.outputs.preview_url }}
          BUNDLE_SIZE: ${{ steps.bundle.outputs.bundle_size }}
        with:
          script: |
            const { PREVIEW_URL, BUNDLE_SIZE } = process.env;

            const body = [
              '## ðŸš€ Preview Deployment',
              '',
              '| Item | Value |',
              '| --- | --- |',
              `| **Preview URL** | [${PREVIEW_URL}](${PREVIEW_URL}) |`,
              `| **Bundle Size** | ${BUNDLE_SIZE} |`,
              `| **Branch** | \`${context.payload.pull_request.head.ref}\` |`,
              `| **Commit** | \`${context.payload.pull_request.head.sha.substring(0, 7)}\` |`,
              '',
              `> â±ï¸ Deployed at ${new Date().toISOString()}`,
            ].join('\n');

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100,
            });

            const botComment = comments.data.find((comment) =>
              comment.user?.type === 'Bot' &&
              comment.body?.includes('## ðŸš€ Preview Deployment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
